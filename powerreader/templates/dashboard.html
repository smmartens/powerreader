<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Powerreader Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .readings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
        }
        .reading-card {
            background: #0f3460;
            border-radius: 6px;
            padding: 0.75rem;
            text-align: center;
        }
        .reading-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #00d4ff;
        }
        .reading-card .label { font-size: 0.8rem; color: #8892b0; margin-top: 0.25rem; }
        .range-buttons { margin-bottom: 0.75rem; }
        .range-buttons button {
            background: #0f3460;
            color: #e0e0e0;
            border: 1px solid #1a5276;
            padding: 0.4rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.25rem;
        }
        .range-buttons button.active { background: #00d4ff; color: #1a1a2e; font-weight: 600; }
        .chart-container { position: relative; width: 100%; max-height: 350px; }
        .timestamp { font-size: 0.75rem; color: #5a6a8a; text-align: right; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <header>
        <h1>Powerreader</h1>
        <nav><a href="/log">Message Log</a></nav>
    </header>

    <div class="panel" id="current-panel">
        <h2>Current Reading</h2>
        <div class="readings" id="current-readings">
            <div class="reading-card">
                <div class="value" id="cur-total">--</div>
                <div class="label">Meter (kWh)</div>
            </div>
            <div class="reading-card">
                <div class="value" id="stat-avg-day">--</div>
                <div class="label">Avg / Day (kWh)</div>
            </div>
            <div class="reading-card">
                <div class="value" id="stat-avg-month">--</div>
                <div class="label">Avg / Month (kWh)</div>
            </div>
            <div class="reading-card">
                <div class="value" id="stat-year">--</div>
                <div class="label">This Year (kWh)</div>
            </div>
        </div>
        <div class="timestamp" id="cur-timestamp"></div>
    </div>

    <div class="panel">
        <h2>Consumption History</h2>
        <div class="range-buttons" id="range-buttons">
            <button class="active" data-range="24h">24h</button>
            <button data-range="7d">7d</button>
            <button data-range="30d">30d</button>
        </div>
        <div class="chart-container">
            <canvas id="history-chart"></canvas>
        </div>
        <div class="no-data" id="history-no-data" style="display:none;">No history data available.</div>
    </div>

    <div class="panel">
        <h2>Average Consumption by Hour of Day</h2>
        <div class="chart-container">
            <canvas id="avg-chart"></canvas>
        </div>
        <div class="no-data" id="avg-no-data" style="display:none;">No average data available.</div>
    </div>

    <footer>
        <span id="footer-version">Powerreader</span>
        <span>
            <a href="https://github.com/smmartens" target="_blank">smmartens</a>
            &middot;
            <a href="https://github.com/smmartens/powerreader" target="_blank">GitHub</a>
        </span>
    </footer>

    <script src="/static/chart.umd.min.js"></script>
    <script src="/static/common.js"></script>
    <script>
        let historyChart = null;
        let avgChart = null;
        let activeRange = "24h";

        // --- Current Reading ---
        async function fetchCurrent() {
            try {
                const resp = await fetch("/api/current");
                if (!resp.ok) return;
                const d = await resp.json();
                document.getElementById("cur-total").textContent =
                    d.total_in != null ? Number(d.total_in).toFixed(1) : "--";
                document.getElementById("cur-timestamp").textContent =
                    d.timestamp ? "Updated: " + d.timestamp : "";
            } catch (_) { /* silent */ }
        }

        // --- Consumption Stats ---
        async function fetchStats() {
            try {
                const resp = await fetch("/api/stats");
                if (!resp.ok) return;
                const d = await resp.json();
                document.getElementById("stat-avg-day").textContent =
                    d.avg_kwh_per_day != null ? Number(d.avg_kwh_per_day).toFixed(1) : "--";
                document.getElementById("stat-avg-month").textContent =
                    d.avg_kwh_per_month != null ? Number(d.avg_kwh_per_month).toFixed(0) : "--";
                document.getElementById("stat-year").textContent =
                    d.kwh_this_year != null ? Number(d.kwh_this_year).toFixed(0) : "--";
            } catch (_) { /* silent */ }
        }

        // --- History Chart ---
        function formatLabel(bucket, range) {
            if (range === "30d") return bucket;  // "2024-01-15"
            // hourly: "2024-01-15T14" -> "Jan 15 14:00"
            const parts = bucket.split("T");
            if (parts.length === 2) {
                const date = new Date(parts[0]);
                const mon = date.toLocaleString("en", { month: "short" });
                return mon + " " + date.getDate() + " " + parts[1] + ":00";
            }
            return bucket;
        }

        async function fetchHistory(range) {
            try {
                const resp = await fetch("/api/history?range=" + range);
                if (!resp.ok) return;
                const body = await resp.json();
                const data = body.data || [];
                const canvas = document.getElementById("history-chart");
                const noData = document.getElementById("history-no-data");

                if (data.length === 0) {
                    historyChart = toggleChartVisibility(canvas, noData, historyChart);
                    return;
                }
                showChart(canvas, noData);

                const labels = data.map(d => formatLabel(d.bucket, range));
                const values = data.map(d => d.avg_power_w);

                if (historyChart) historyChart.destroy();
                historyChart = new Chart(canvas, {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Consumption (Wh)",
                            data: values,
                            borderColor: "#00d4ff",
                            backgroundColor: "rgba(0,212,255,0.1)",
                            fill: true,
                            tension: 0.3,
                            pointRadius: range === "30d" ? 3 : 1,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                ticks: { color: "#8892b0", maxRotation: 45, maxTicksLimit: 12 },
                                grid: { color: "rgba(255,255,255,0.05)" }
                            },
                            y: {
                                ticks: { color: "#8892b0" },
                                grid: { color: "rgba(255,255,255,0.05)" },
                                title: { display: true, text: "Wh", color: "#8892b0" }
                            }
                        }
                    }
                });
            } catch (_) { /* silent */ }
        }

        // --- Average by Hour of Day ---
        async function fetchAverages() {
            try {
                const resp = await fetch("/api/averages?days=30");
                if (!resp.ok) return;
                const body = await resp.json();
                const data = body.data || [];
                const canvas = document.getElementById("avg-chart");
                const noData = document.getElementById("avg-no-data");

                if (data.length === 0) {
                    avgChart = toggleChartVisibility(canvas, noData, avgChart);
                    return;
                }
                showChart(canvas, noData);

                // Fill all 24 hours
                const byHour = new Array(24).fill(0);
                data.forEach(d => { byHour[d.hour_of_day] = d.avg_power_w; });
                const labels = Array.from({ length: 24 }, (_, i) => String(i).padStart(2, "0") + ":00");

                if (avgChart) avgChart.destroy();
                avgChart = new Chart(canvas, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Avg Consumption (Wh)",
                            data: byHour,
                            backgroundColor: "rgba(0,212,255,0.6)",
                            borderColor: "#00d4ff",
                            borderWidth: 1,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                ticks: { color: "#8892b0" },
                                grid: { color: "rgba(255,255,255,0.05)" }
                            },
                            y: {
                                ticks: { color: "#8892b0" },
                                grid: { color: "rgba(255,255,255,0.05)" },
                                title: { display: true, text: "Wh", color: "#8892b0" }
                            }
                        }
                    }
                });
            } catch (_) { /* silent */ }
        }

        // --- Range toggle ---
        document.getElementById("range-buttons").addEventListener("click", (e) => {
            if (e.target.tagName !== "BUTTON") return;
            document.querySelectorAll("#range-buttons button").forEach(b => b.classList.remove("active"));
            e.target.classList.add("active");
            activeRange = e.target.dataset.range;
            fetchHistory(activeRange);
        });

        // --- Init ---
        initVersionFooter();
        fetchCurrent();
        fetchStats();
        fetchHistory(activeRange);
        fetchAverages();
        setInterval(fetchCurrent, REFRESH_MS);
        setInterval(fetchStats, REFRESH_MS);
    </script>
</body>
</html>
